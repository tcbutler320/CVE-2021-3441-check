import requests
import json
import sys
import getopt 
import urllib
import os 
import subprocess 
import re
import datetime
from bs4 import BeautifulSoup as bs
import lib.core.constants as c 
from lib.core.module_parser import parser

# Connect to target and request page
def request(infile,outfile,verbosity):
    counter = 0
    with open(infile) as target_list: 
        fstring = target_list.readlines() 
    pattern = re.compile(r'(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})') 
    targets = []
    for line in fstring:
        targets.append(pattern.search(line)[0]) 
    for url in targets: 
        path = 'http://' + url # The IP of the vulnerable target 
        full_path = path  + '/DevMgmt/ProductConfigDyn.xml'   
        headers = {
            'Host':url, 
            'User-Agent':c.user_agent,
            'Accept':'*/*',
            'Accept-Language':'en-US,en;q=0.5',
            'Accept-Encoding':'gzip, deflate',
            'Content-Type':'text/xml',
            'Content-Length':0,
            'Connection':'close',
            'Referer':path,
        }

       # TODO: 

        try:
            sys.stdout.write(c.Yellow)
            if verbosity == 1:
                print('{!} Test #',counter,'Testing target: ',url)
            response = requests.get(full_path, timeout= c.timeout_seconds)
            response.raise_for_status()
            counter += 1
        except:
            sys.stdout.write(c.BIGreen)
            if verbosity == 1:
                print('{X} -------- Exception')
            continue
        else:
            sys.stdout.write(c.BIGreen)
            if verbosity == 1:
                if response.status_code == 200: 
                    print('{!} -------- {INFO}: OK Response, Status Code:',response.status_code)
                    return response, url, counter 
    return 



def check_header(target):


    return 